
# 顾及局部最优的手机端GNSS阴影匹配定位算法

## 1.摘要

> ***建筑物反射的卫星信号***  以及 ***多路径效应*** （接收机在接收到卫星发射的直射信号的同时，还可能接收到来自测站周围地物的反射信号，两种信号 **干涉叠加** ，引起附加时间延迟或相位延迟，从而使观测值偏离真值，产生所谓的多路径误差）的影响，使得误差很大
>
> > * 传统阴影匹配算法利用 ***3D城市模型***  进行卫星可见性预测与位置匹配
> >
> > > ***缺点*** ：实际观测环境与理想观测环境不同， 存在固定阈值打分，卫星利用率低，选取高分候选位置不合理等问题。
> >
> > >***优点*** ： 降低伪距单点定位误差。（***伪距*** ：由于卫星钟、接收机钟的误差以及卫星信号经过电离层和对流层中的延迟影响，得出的距离不等于卫星到接收机的几何距离，因此被称为伪距）
> >
> > * 顾及局部最优的阴影匹配定位算法。
> >
> > >***优点*** ：根据 ***固定区间的信噪比*** 确定局部候选区域，采用 ***连续信噪比打分公式***  对候选位置点进行评分，***归一化*** 选取高分候选位置以及 ***加权平均处理*** 得到定位结果。
> > >
> > >***效果*** ：相较于伪距单点定位和传统阴影匹配算法精度提高了约 ***75%*** 和 ***50%*** 。绝对定位精度达到 ***5m*** 左右 。动态试验中跨街方向的定位精度达到了 ***1.36m*** 。

## 2. 调研

​	高层建筑使得GNSS卫星信号在传播路径上发生反射、折射和衍射，使得伪距单点误差高达数十米甚至上百米。

## 国外研究

> Yoon使用 ***差分GNSS***（DGNSS）提高精度
>
> Moreau提出 ***增加额外设备*** ，如鱼眼相机，通过图像识别，三维激光雷达来测量设备到周围建筑物的距离修正误差。
>
> Hisaka利用 ***3D城市模型模拟光线反射路径*** ，修正NLOS信号延迟
>
> Isaacs采用 ***贝叶斯及结合3D城市模型***
>
> Grove等提出 ***通过地形高度数据库辅助阴影匹配算法*** ，使用 ***KNN*** 对候选位置求解。
>
> Li-Ta Hsu 利用 ***3D城市模型光线追踪*** 模拟LOS和NLOS信号的伪距测量值，通过对比模拟测量误差与实际误差来筛选候选位置，***深度学习*** 区分LOS和NLOS的卫星，采用 ***多个GNSS接收机同时段观测来消除NLOS***。

## 国内研究

> 胡辉研究 ***阴影匹配与粒子滤波的自适应加权算法***。
>
> 罗欢研究采用 ***低通滤波*** 减小阴影匹配中信噪比波动过大的问题，***聚类分析*** 求出坐标。
>
> 王式太提出 ***动态阈值阴影匹配算法***



* 伪距单点定位：以最小二乘为核心，通过距离交会 ***（以两个已知控制点为中心，分别以目标点与两已知控制点的*距离*为半径划圆，*交会*点即为要求目标点（注意方向二选其中一个））***的形式来确定接收机的位置。
* 传统阴影匹配算法：对每颗卫星的可见性预测进行一个得分进行累加，在候选位置点出选出得分前5%的候选位置，加权平均其坐标的得到位置。但由于采用固定阈值对卫星的可见性进行分类，使得未能充分利用各个卫星。（低于或者高于该阈值的卫星的观测结果丢失）
* 局部最优的阴影匹配算法：按照固定区间的信噪比打分结果在全局候选区内确定局部候选区域，再对局部候选区域内的候选位置点采用连续信噪比打分公式进行打分，归一化局部候选位置点的得分，选取最高得分的候选位置进行加权平均，得到最终结果。

## 传统阴影匹配算法

确定伪距单点定位坐标，以误差极限值50m为半径，画一个圆形，在该范围内以1m为间隔设置 ***全局候选点集***。

***卫星可见性预测***   

通过三维工具对建筑物顶面的所有边线进行提取，经过一系列方式得到高度角，不断更新 ***天空阴影矩阵***。天空阴影矩阵中的各个高度角在极坐标系下连线形成的折线图就是天空阴影图，根据广播星历计算每颗卫星的高度角和方位角，根据卫星在该阴影图的位置判断每颗卫星的可见性。

***固定区间信噪比评分***

卫星为LOS卫星，且信噪比大于等于35dB-Hz，得1分

卫星为NLOS卫星，心在比小于25dB-Hz，得1分

信噪比在25-35之间的，得0.5分

其他情况均0分

***阴影匹配算法流程***

对每个候选位置点上的每个卫星进行固定区间信噪比评分，每个候选点上所有卫星的得分总和就是该候选点得分。对候选位置点集中的得分前5%的候选位置点进行加权平均处理，得到的值就是最终定位结果。
$$
G = \sum_{i=1}^nS_i
$$

$$
Pos = (\sum_{k=1}^m P_kG_k)/(\sum_{k=1}^mF_k)
$$



> 缺点：卫星分类过于严格，其他区间信噪比的卫星未能利用；没有扣分机制；按固定比例选取高分候选位置可能存在漏选得分较高的候选位置，或多选得分较低候选位置等情况。

## 局部最优阴影匹配算法

​	通过三维工具提取道路区域的多边形边界点，根据与周围建筑物的相似性，将找到路候选区域划分成不同的局部候选区域。结合传统阴影匹配定位结果，将真实位置所在的区域的点作为 ***局部候选区域***，全局候选点集同上。

***连续信噪比评分***

​	对局部候选区域内部的局部候选位置点集在遮挡环境和开阔环境下分别进行实测，对出现爱你的信噪比区间进行概率上的高斯拟合，得到概率密度曲线和概率分布曲线，根据上述两个曲线的特征来选取拒绝域，然后按区间中心对称来进行打分。

***归一化和加权平均***

​	在局部候选区域内部对所有候选位置点进行局部最优阴影匹配打分，按得分高低对所有局部候选点进行排序，取得分最高的前20个点得分的均值
$$
G_H = (\sum_{i=1}^{20}G_i)/20
$$
，得分最低的后20个点得分的均值
$$
G_L = (\sum_{i=n-20}^{n}G_i)/20
$$
归一化的得分
$$
G_i^` = (G_i - G_L) / (G_H - G_L)
$$
Pos为
$$
Pos = (\sum_{k=1}^{m} P_KG_k^`)/(\sum_{k=1}^{m}G_k)
$$








# Smartphone Shadow Matching for Better Cross-street GNSS Positioning in Urban Environment

$$
\color{red}说人话就是，其他的和上一个都一样(这个将算法布置在了手机端)\\
\color{red}就是计算得分的时候使用了贝叶斯网络，计算概率\\
\color{red}通过概率的方式来进行得分计算。
$$





## 1.摘要

> ​	***GNSS阴影匹配*** 将测量到的信号可用性和强度使用 ***3D城市模型*** 来进行预测
>
> **优点**：可以显著提高在密集城市环境下 ***十字路口***  的精度
>
> **特点**：***基于Android手机***  ，在手机端进行部署；LOS和NLOS进行***信噪比***分析

## Introduction

> 垂直于街道的LOS信号比沿着街道的LOS信号更容易被遮挡，然而垂直于街道的信号往往对于应用是十分重要的

> 3D建模估计可以提供额外的数据源
>
> 用多颗卫星对用户进行定位，能够解决由于高楼等对LOS信号的遮挡从而削减位置阻挡。

> 阴影匹配技术可以区分人行道和车道；基于阴影匹配方法用于长观测时间的精确定位；使用电线杆阴影进行道路车道识别。
>
> ***缺点*** ：
>
> > 阴影匹配度的大多数应用使用消费级GNSS，其天线具有较低的收益和较少的极化辨别，用信噪比区分LOS和NLOS比较困难。
>
> >智能手机的天线收益最低，并且线极化，不能区分LOS和NLOS，并且与手机的方向有关，此外手机对信号比较敏感，会追踪很多较弱的NLOS信号，降低匹配性能。

## 阴影匹配算法

* 离线阶段：从3D模型中确定建筑边界数据并进行存储
* 在线阶段：根据建筑物边界和GNSS的测量值在4步内确定Pos

> ***确定搜索区域(search grid)***
>
> > 首先定义一个搜索网格，基于传统GNSS或者其他方法（蓝牙或者电话信号）的初始位置。
>
> ***预测卫星可见性***
>
> > 在搜索区域中的每个位置进行，将卫星的搞成与相同方位角的建筑物边界高程进行比较，预测该卫星的可见性。
>
> ***卫星可见性得分***
>
> > 根据预测和观测到的可见度，对接收机仰角以上的每颗卫星进行打分。然后通过对单个卫星得分求和来确定没个候选位置的总得分。
>
> ***应用定位算法***
>
> > 使用每个候选位置的分数生成对应的位置解。
> >
> > > **目前仅仅是简单的取得分最高的网格位置的平均值**，计划在未来的工作中开发更复杂的位置估计算法。

## 实验数据集

​	使用的是三星Galaxy S3智能手机。信噪比测量、卫星方位角、和高程以及传统的GNSS位置解决方案在NMEA的信息，来自手机的GNSS芯片。

​	3D模型来自于ZMapping Ltd。它具有分米级精度的混合细节级别LoD 1和LoD 2模型，用  ***虚拟现实建模语言*** （VRML）格式来存储。LoD 1包括建筑物的二维形状和其高度信息；LoD 2描述了建筑物的边界。

> 分别选取十对在道路两侧的地点，静止站立两轮，每轮6分钟，采集间隔大约是4小时。用第一轮数据测试阴影匹配算法，第二轮数据进行分析。
>
> 使用tape来测量到一个 ***独特特征的距离***  **（建筑物墙壁或道路和人行道之间的路边石）**来确定真实参考，然后将该特征定位到3D模型中。

## 手机对于LOS和NLOS的信号强度分析

> 信噪比

​	接收到的具有较高SNR时间序列的信号更可能是LOS而不是NLOS。由于反射、遮挡等等问题，会使得某些LOS较弱或者某些NLOS的信号比LOS的信号强。

​	智能手机天线的特性使得使用SNR测量来区分LOS和NLOS困难。

​	分析智能手机接收到的LOS和NLOS信号的信噪比分布，利用可见度预测方法和用户真实位置的知识，使用3D模型来区分接收信号。对LOS和NLOS的测量SNR进行归一化分布

![image-20240513153803763](C:\Users\MHB\AppData\Roaming\Typora\typora-user-images\image-20240513153803763.png)



## 卫星可见性评分方案

​	智能手机接收到的LOS和NLOS信号的SNR分布存在重叠，采用概率方法根据测量的SNR信号估计LOS的概率，根据3D城市模型的卫星可见度来进行评估。

***贝叶斯网络***
$$
\boxed{P(LOS|SNR=s) = \frac{P(SNR = s|LOS)P(LOS)}{P(SNR = s)}}
$$

$$
给定测量SNR为s的时候，观测信号为LOS的概率为 \boxed{P(LOS | SNR = s)}
$$

$$
P(LOS)为信号直接为LOS的概率，\boxed{P（SNR=s)} 是被测SNR为s的概率。
$$

$$
\boxed{l_i}是被测信号直接为LOS且所测SNR为i的比例
$$

$$
\boxed{n_i}是被测信号为NLOS并且所测SNR为i的比例
$$

那么
$$
P(SNR=s|LOS) = \frac{l_s}{\sum_i l_i} \\
P(LOS) = \sum_i l_i \\
P(SNR = s) = l_s + n_s \quad其中\sum_i{(l_i+n_i)} = 1 \\
P(LOS|SNR=s) = \frac{l_s}{l_s + n_s}
$$
根据坐标点进行函数拟合，得到
$$
P(LOS|SNR = s)= \begin{cases}
p_{o - min} & s < s_{min} \\
a_2s^2+a_1s+a_0  & s_{min}<s<s_{max} \\
p_{o -max} & s_{max} < s
\end{cases}\\
说明：\\
p_{o-min}和p_{o-max}是LOS观测到的最小和最大概率\\
s_{min}和s_{max}分别是二次函数适用时的最小和信噪比最大 \\
a_2,a_1,a_0分别是二次函数的参数
$$
***该模型使用智能手机进行训练***，使用另一款手机的时候可能需要也可能不需要进行参数调整，当手机放在包里或者口袋的时候，也可能需要不同的值。***上下文检测算法***  用来判断使用哪个参数集。
$$
预测和测量的卫星能见度匹配的概率 \\
P_m = 1-P(LOS|SNR=s)-P(LOS|BB)-2P(LOS|SNR=s)P(LOS|BB) \\
P(LOS|BB)从建筑物边界接收到LOS信号的概率（这个值允许衍射和3D模型误差）
$$
然后计算基于对数似然法的0-1之间的得分
$$
f_{sat} = \frac{log(P_m) - log(P_{m-min})}{log(P_{m-max}) - log(P_{m - min})}\\
P_{m-min}和P_{m-max}是定值
$$

## 基于智能手机GPS和SNSS数据的阴影匹配性评估

使用10对数据第一轮测量的数据进行评估。以智能手机GNSS的芯片为中心，半径40m的圆定义了阴影匹配搜索区域，在该区域内生成候选位置。

> 卫星可见度评分
>
> > 得分最高的为暗红色，最低为深蓝色，真实位置为黑色
>
> 与传统GNSS的性能比较
>
> >在大多数情况下，优于传统GNSS。新的阴影匹配算法优于传统阴影匹配算法。在极少数情况，接受了大量强信号使得混淆了阴影匹配算法。

## 大规模阴影匹配

> ***基于服务器的方法*** ： 使用来自用户的GNSS数据在远程服务器上实现计算，但是需要通信链路来确定位置解决方案。
>
> ***基于手机的方法*** ： 所有的实时计算都在用户设备内执行，但是可用的处理资源会限制搜索区域，网格间距、匹配算法的复杂程度，会影响性能。

## 进一步研究

开发一种新的定位算法，处理评分网络中的多个极大值，结合多个epoch。

结合3D地图的高度辅助和其他技术的信息。













# 三维建筑模型辅助快照定位算法

## 摘要

> 使用 ***3D建筑模型和光线追踪算法***  预测在候选位置上反射信号的接收路径的数量和相应的路径延迟，然后计算最小二乘拟合，选择残差最小的位置作为位置估计。
>
> ***效果*** ：***沿轨道方向*** 的RMS误差减少了 ***31%*** ，在  ***跨轨道方向***  的RMS误差减少了 ***63%*** ，在 ***水平面***上的RMS误差减少了 ***53%*** 。

## Introduction

> 与其他传感器/系统集成。
>
> 改进GNSS接收机，如矢量跟踪。
>
> 使用多GNSS来增加测量次数
>
> 采用信号参数估计技术

​	提出一种新的3DBM辅助定位算法，利用NLOS信号，GNSS数据快照，在城市中提供准确的定位。

​	基于匹配的GNSS接收机相关器输出中存在的观测信号参数，以及从3DBM和光线跟踪算法获得的信号参数，预测几个候选点的信号参数，最接近真实点的候选点应与观测道德相关器的输出结果产生最佳一致性，该点被认为最终点。

> 创新点
>
> * 输入：从GNSS样本的短快照生成的原始相关器输出。而不是伪距或者信噪比。
> * 更节能高效
> * 消除由于用户运动、信号衰减、跟踪环路不稳定等信息。
>
> * 减少了所有相关器导致的信息丢失。

## 3DBM辅助快照定位算法

> 1. 使用任何可用的方法获得大致的初始位置
> 2. 在初始位置周围定义一个位置网格（PG),PG中的每一个点被称为候选点（CP）
> 3. 使用3DBM，卫星位置信息和光线追踪算法在每个CP处预测LOS信号可用性、NLOS信号的数量及其相对于LOS相应路径的延迟。
> 4. 相关器输出包含与接收器的真实位置相对的真实信号参数。考虑信号功率Z，同相和四相相关器输出I、Q。
> 5. 匹配预测和观测信号参数。

$$
\color{red}信号的多普勒频移也可以用来估计速度，但是该论文中并没有体现。
$$



* 匹配预测和观测到的信号参数

​	利用最小而成残差对观测到的信号参数进行匹配，选取残差最小的CP作为最终的位置估计。

> 第一步：使用预测信号路径总数来选择相关器模型，该模型用作LSQ估计的数学模型。估计了最短路径的绝对编码相位，估计了所有较长的路径相对于最短路径的延迟。
>
> 第二步：使用预测的相对路径延迟初始化状态向量。然后根据用于相对路径延迟预测的3DBM的精度，相应的状态的先验协方差矩阵也被初始化。然后迭代最小二乘得到的状态向量LSQ估计。                        
>
> 第三步：计算每个卫星每个CP的残差的平方根和，然后在给定历元对所有微星的每个CP残差的RSS求根和，得到总体RSS值，选取总体RSS值最小的CP作为最终位置估计。                                      

## 数据收集和处理

> 数据收集
>
> > 包括一个NovAtel SPAN-LCI参考系统，一个用于L1中频（IF）采样记录的NI前端（20 Msps）、一个NovAtel天线和一个基站。
>
> 数据处理
>
> > 采用卡尔加里大学的GSNRxsoftware接收器进行处理，相关器输出以1hz的速率保存到文件中。





